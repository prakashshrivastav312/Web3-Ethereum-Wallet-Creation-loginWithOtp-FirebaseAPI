{"ast":null,"code":"var typeforce = require('typeforce');\n\nvar types = require('./types');\n\nvar BigInteger = require('bigi');\n\nvar ECSignature = require('./ecsignature');\n\nvar ecurve = require('ecurve');\n\nvar secp256k1 = ecurve.getCurveByName('secp256k1');\n\nvar deterministicGenerateK = require('./rfc6979').deterministicGenerateK;\n\nvar N_OVER_TWO = secp256k1.n.shiftRight(1);\n\nfunction sign(hash, d) {\n  typeforce(types.tuple(types.Hash256bit, types.BigInt), arguments);\n  var x = d.toBuffer(32);\n  var e = BigInteger.fromBuffer(hash);\n  var n = secp256k1.n;\n  var G = secp256k1.G;\n  var r, s;\n  deterministicGenerateK(hash, x, function (k) {\n    var Q = G.multiply(k);\n    if (secp256k1.isInfinity(Q)) return false;\n    r = Q.affineX.mod(n);\n    if (r.signum() === 0) return false;\n    s = k.modInverse(n).multiply(e.add(d.multiply(r))).mod(n);\n    if (s.signum() === 0) return false;\n    return true;\n  }); // enforce low S values, see bip62: 'low s values in signatures'\n\n  if (s.compareTo(N_OVER_TWO) > 0) {\n    s = n.subtract(s);\n  }\n\n  return new ECSignature(r, s);\n}\n\nfunction verify(hash, signature, Q) {\n  typeforce(types.tuple(types.Hash256bit, types.ECSignature, types.ECPoint), arguments);\n  var n = secp256k1.n;\n  var G = secp256k1.G;\n  var r = signature.r;\n  var s = signature.s; // 1.4.1 Enforce r and s are both integers in the interval [1, n − 1]\n\n  if (r.signum() <= 0 || r.compareTo(n) >= 0) return false;\n  if (s.signum() <= 0 || s.compareTo(n) >= 0) return false; // 1.4.2 H = Hash(M), already done by the user\n  // 1.4.3 e = H\n\n  var e = BigInteger.fromBuffer(hash); // Compute s^-1\n\n  var sInv = s.modInverse(n); // 1.4.4 Compute u1 = es^−1 mod n\n  //               u2 = rs^−1 mod n\n\n  var u1 = e.multiply(sInv).mod(n);\n  var u2 = r.multiply(sInv).mod(n); // 1.4.5 Compute R = (xR, yR)\n  //               R = u1G + u2Q\n\n  var R = G.multiplyTwo(u1, Q, u2); // 1.4.5 (cont.) Enforce R is not at infinity\n\n  if (secp256k1.isInfinity(R)) return false; // 1.4.6 Convert the field element R.x to an integer\n\n  var xR = R.affineX; // 1.4.7 Set v = xR mod n\n\n  var v = xR.mod(n); // 1.4.8 If v = r, output \"valid\", and if v != r, output \"invalid\"\n\n  return v.equals(r);\n}\n\nmodule.exports = {\n  deterministicGenerateK: deterministicGenerateK,\n  sign: sign,\n  verify: verify,\n  // TODO: remove\n  __curve: secp256k1\n};","map":{"version":3,"names":["typeforce","require","types","BigInteger","ECSignature","ecurve","secp256k1","getCurveByName","deterministicGenerateK","N_OVER_TWO","n","shiftRight","sign","hash","d","tuple","Hash256bit","BigInt","arguments","x","toBuffer","e","fromBuffer","G","r","s","k","Q","multiply","isInfinity","affineX","mod","signum","modInverse","add","compareTo","subtract","verify","signature","ECPoint","sInv","u1","u2","R","multiplyTwo","xR","v","equals","module","exports","__curve"],"sources":["C:/Users/acer/node_modules/@tatumio/bitcoincashjs2-lib/src/ecdsa.js"],"sourcesContent":["var typeforce = require('typeforce')\nvar types = require('./types')\n\nvar BigInteger = require('bigi')\nvar ECSignature = require('./ecsignature')\n\nvar ecurve = require('ecurve')\nvar secp256k1 = ecurve.getCurveByName('secp256k1')\n\nvar deterministicGenerateK = require('./rfc6979').deterministicGenerateK\n\nvar N_OVER_TWO = secp256k1.n.shiftRight(1)\n\nfunction sign (hash, d) {\n  typeforce(types.tuple(types.Hash256bit, types.BigInt), arguments)\n\n  var x = d.toBuffer(32)\n  var e = BigInteger.fromBuffer(hash)\n  var n = secp256k1.n\n  var G = secp256k1.G\n\n  var r, s\n  deterministicGenerateK(hash, x, function (k) {\n    var Q = G.multiply(k)\n\n    if (secp256k1.isInfinity(Q)) return false\n\n    r = Q.affineX.mod(n)\n    if (r.signum() === 0) return false\n\n    s = k.modInverse(n).multiply(e.add(d.multiply(r))).mod(n)\n    if (s.signum() === 0) return false\n\n    return true\n  })\n\n  // enforce low S values, see bip62: 'low s values in signatures'\n  if (s.compareTo(N_OVER_TWO) > 0) {\n    s = n.subtract(s)\n  }\n\n  return new ECSignature(r, s)\n}\n\nfunction verify (hash, signature, Q) {\n  typeforce(types.tuple(\n    types.Hash256bit,\n    types.ECSignature,\n    types.ECPoint\n  ), arguments)\n\n  var n = secp256k1.n\n  var G = secp256k1.G\n\n  var r = signature.r\n  var s = signature.s\n\n  // 1.4.1 Enforce r and s are both integers in the interval [1, n − 1]\n  if (r.signum() <= 0 || r.compareTo(n) >= 0) return false\n  if (s.signum() <= 0 || s.compareTo(n) >= 0) return false\n\n  // 1.4.2 H = Hash(M), already done by the user\n  // 1.4.3 e = H\n  var e = BigInteger.fromBuffer(hash)\n\n  // Compute s^-1\n  var sInv = s.modInverse(n)\n\n  // 1.4.4 Compute u1 = es^−1 mod n\n  //               u2 = rs^−1 mod n\n  var u1 = e.multiply(sInv).mod(n)\n  var u2 = r.multiply(sInv).mod(n)\n\n  // 1.4.5 Compute R = (xR, yR)\n  //               R = u1G + u2Q\n  var R = G.multiplyTwo(u1, Q, u2)\n\n  // 1.4.5 (cont.) Enforce R is not at infinity\n  if (secp256k1.isInfinity(R)) return false\n\n  // 1.4.6 Convert the field element R.x to an integer\n  var xR = R.affineX\n\n  // 1.4.7 Set v = xR mod n\n  var v = xR.mod(n)\n\n  // 1.4.8 If v = r, output \"valid\", and if v != r, output \"invalid\"\n  return v.equals(r)\n}\n\nmodule.exports = {\n  deterministicGenerateK: deterministicGenerateK,\n  sign: sign,\n  verify: verify,\n\n  // TODO: remove\n  __curve: secp256k1\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}