{"ast":null,"code":"\"use strict\";\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.prepareBitcoinSignedOffchainTransaction = exports.signBitcoinOffchainKMSTransaction = exports.sendBitcoinOffchainTransaction = void 0;\n\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\")); // @ts-ignore\n\n\nconst bitcore_lib_1 = require(\"bitcore-lib\");\n\nconst tatum_1 = require(\"../connector/tatum\");\n\nconst model_1 = require(\"../model\");\n\nconst wallet_1 = require(\"../wallet\");\n\nconst common_1 = require(\"./common\");\n\nconst kms_1 = require(\"./kms\");\n/**\n * Send Bitcoin transaction from Tatum Ledger account to the blockchain. This method broadcasts signed transaction to the blockchain.\n * This operation is irreversible.\n * @param testnet mainnet or testnet version\n * @param body content of the transaction to broadcast\n * @returns transaction id of the transaction in the blockchain or id of the withdrawal, if it was not cancelled automatically\n */\n\n\nconst sendBitcoinOffchainTransaction = async (testnet, body) => {\n  if (body.signatureId) {\n    return kms_1.offchainTransferBtcKMS(body);\n  }\n\n  await tatum_1.validateBody(body, model_1.TransferBtcBasedOffchain);\n\n  const {\n    mnemonic,\n    keyPair,\n    xpub,\n    attr: changeAddress\n  } = body,\n        withdrawal = __rest(body, [\"mnemonic\", \"keyPair\", \"xpub\", \"attr\"]);\n\n  if (!withdrawal.fee) {\n    withdrawal.fee = '0.0005';\n  }\n\n  const {\n    id,\n    data\n  } = await common_1.offchainStoreWithdrawal(withdrawal);\n  const {\n    amount,\n    address\n  } = withdrawal;\n  let txData;\n\n  try {\n    txData = await exports.prepareBitcoinSignedOffchainTransaction(testnet, data, amount, address, mnemonic, keyPair, changeAddress, xpub, withdrawal.multipleAmounts);\n  } catch (e) {\n    console.error(e);\n    await common_1.offchainCancelWithdrawal(id);\n    throw e;\n  }\n\n  try {\n    return Object.assign(Object.assign({}, await common_1.offchainBroadcast({\n      txData,\n      withdrawalId: id,\n      currency: model_1.Currency.BTC\n    })), {\n      id\n    });\n  } catch (e) {\n    console.error(e);\n\n    try {\n      await common_1.offchainCancelWithdrawal(id);\n    } catch (e1) {\n      console.log(e);\n      return {\n        id\n      };\n    }\n\n    throw e;\n  }\n};\n\nexports.sendBitcoinOffchainTransaction = sendBitcoinOffchainTransaction;\n/**\n * Sign Bitcoin pending transaction from Tatum KMS\n * @param tx pending transaction from KMS\n * @param mnemonic mnemonic to generate private keys to sign transaction with.\n * @param testnet mainnet or testnet version\n * @returns transaction data to be broadcast to blockchain.\n */\n\nconst signBitcoinOffchainKMSTransaction = async (tx, mnemonic, testnet) => {\n  var _a;\n\n  if (tx.chain !== model_1.Currency.BTC || !tx.withdrawalResponses) {\n    throw Error('Unsupported chain.');\n  }\n\n  const builder = new bitcore_lib_1.Transaction(JSON.parse(tx.serializedTransaction));\n\n  for (const response of tx.withdrawalResponses) {\n    if (response.vIn === '-1') {\n      continue;\n    }\n\n    builder.sign(bitcore_lib_1.PrivateKey.fromWIF(await wallet_1.generatePrivateKeyFromMnemonic(model_1.Currency.BTC, testnet, mnemonic, ((_a = response.address) === null || _a === void 0 ? void 0 : _a.derivationKey) || 0)));\n  }\n\n  return builder.serialize(true);\n};\n\nexports.signBitcoinOffchainKMSTransaction = signBitcoinOffchainKMSTransaction;\n/**\n * Sign Bitcoin transaction with private keys locally. Nothing is broadcast to the blockchain.\n * @param testnet mainnet or testnet version\n * @param data data from Tatum system to prepare transaction from\n * @param amount amount to send\n * @param address recipient address, if multiple recipients are present, it should be string separated by ','\n * @param mnemonic mnemonic to sign transaction from. mnemonic or keyPair must be present\n * @param keyPair keyPair to sign transaction from. keyPair or mnemonic must be present\n * @param changeAddress address to send the rest of the unused coins\n * @param xpub xpub of the wallet\n * @param multipleAmounts if multiple recipients are present in the address separated by ',', this should be list of amounts to send\n * @param signatureId if using KMS, this is signatureId of the wallet representing mnemonic\n * @returns transaction data to be broadcast to blockchain.\n */\n\nconst prepareBitcoinSignedOffchainTransaction = async (testnet, data, amount, address, mnemonic, keyPair, changeAddress, xpub, multipleAmounts, signatureId) => {\n  var _a;\n\n  const tx = new bitcore_lib_1.Transaction();\n  data.forEach(input => {\n    if (input.vIn !== '-1') {\n      tx.from({\n        txId: input.vIn,\n        outputIndex: input.vInIndex,\n        script: bitcore_lib_1.Script.fromAddress(input.address.address).toString(),\n        satoshis: Number(new bignumber_js_1.default(input.amount).multipliedBy(100000000).toFixed(8, bignumber_js_1.default.ROUND_FLOOR))\n      });\n    }\n  });\n  const lastVin = data.find(d => d.vIn === '-1');\n\n  if (multipleAmounts === null || multipleAmounts === void 0 ? void 0 : multipleAmounts.length) {\n    for (const [i, multipleAmount] of multipleAmounts.entries()) {\n      tx.to(address.split(',')[i], Number(new bignumber_js_1.default(multipleAmount).multipliedBy(100000000).toFixed(8, bignumber_js_1.default.ROUND_FLOOR)));\n    }\n  } else {\n    tx.to(address, Number(new bignumber_js_1.default(amount).multipliedBy(100000000).toFixed(8, bignumber_js_1.default.ROUND_FLOOR)));\n  }\n\n  if (new bignumber_js_1.default(lastVin.amount).isGreaterThan(0)) {\n    if (xpub) {\n      tx.to(wallet_1.generateAddressFromXPub(model_1.Currency.BTC, testnet, xpub, 0), Number(new bignumber_js_1.default(lastVin.amount).multipliedBy(100000000).toFixed(8, bignumber_js_1.default.ROUND_FLOOR)));\n    } else if (changeAddress) {\n      tx.to(changeAddress, Number(new bignumber_js_1.default(lastVin.amount).multipliedBy(100000000).toFixed(8, bignumber_js_1.default.ROUND_FLOOR)));\n    } else {\n      throw new Error('Impossible to prepare transaction. Either mnemonic or keyPair and attr must be present.');\n    }\n  }\n\n  if (signatureId) {\n    return JSON.stringify(tx);\n  }\n\n  for (const input of data) {\n    // when there is no address field present, input is pool transfer to 0\n    if (input.vIn === '-1') {\n      continue;\n    }\n\n    if (mnemonic) {\n      const derivationKey = ((_a = input.address) === null || _a === void 0 ? void 0 : _a.derivationKey) || 0;\n      tx.sign(bitcore_lib_1.PrivateKey.fromWIF(await wallet_1.generatePrivateKeyFromMnemonic(model_1.Currency.BTC, testnet, mnemonic, derivationKey)));\n    } else if (keyPair) {\n      const {\n        privateKey\n      } = keyPair.find(k => k.address === input.address.address);\n      tx.sign(bitcore_lib_1.PrivateKey.fromWIF(privateKey));\n    } else {\n      throw new Error('Impossible to prepare transaction. Either mnemonic or keyPair and attr must be present.');\n    }\n  }\n\n  return tx.serialize(true);\n};\n\nexports.prepareBitcoinSignedOffchainTransaction = prepareBitcoinSignedOffchainTransaction;","map":{"version":3,"mappings":"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","names":["sendBitcoinOffchainTransaction","testnet","body","signatureId","kms_1","tatum_1","model_1","mnemonic","keyPair","xpub","attr","changeAddress","withdrawal","fee","id","data","common_1","amount","address","txData","exports","multipleAmounts","e","console","error","withdrawalId","currency","BTC","e1","log","signBitcoinOffchainKMSTransaction","tx","chain","withdrawalResponses","Error","builder","bitcore_lib_1","JSON","parse","serializedTransaction","response","vIn","sign","fromWIF","wallet_1","_a","derivationKey","serialize","prepareBitcoinSignedOffchainTransaction","forEach","input","from","txId","outputIndex","vInIndex","script","fromAddress","toString","satoshis","Number","bignumber_js_1","multipliedBy","toFixed","ROUND_FLOOR","lastVin","find","d","length","i","multipleAmount","entries","to","split","isGreaterThan","stringify","privateKey","k"],"sourceRoot":"","sources":["../../../src/offchain/bitcoin.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}