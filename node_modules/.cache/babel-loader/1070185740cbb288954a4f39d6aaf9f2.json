{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.NodeHttpTransport = void 0;\n\nvar http = require(\"http\");\n\nvar https = require(\"https\");\n\nvar url = require(\"url\");\n\nvar grpc_web_1 = require(\"@improbable-eng/grpc-web\");\n\nfunction NodeHttpTransport() {\n  return function (opts) {\n    return new NodeHttp(opts);\n  };\n}\n\nexports.NodeHttpTransport = NodeHttpTransport;\n\nvar NodeHttp = function () {\n  function NodeHttp(transportOptions) {\n    this.options = transportOptions;\n  }\n\n  NodeHttp.prototype.sendMessage = function (msgBytes) {\n    if (!this.options.methodDefinition.requestStream && !this.options.methodDefinition.responseStream) {\n      this.request.setHeader(\"Content-Length\", msgBytes.byteLength);\n    }\n\n    this.request.write(toBuffer(msgBytes));\n    this.request.end();\n  };\n\n  NodeHttp.prototype.finishSend = function () {};\n\n  NodeHttp.prototype.responseCallback = function (response) {\n    var _this = this;\n\n    this.options.debug && console.log(\"NodeHttp.response\", response.statusCode);\n    var headers = filterHeadersForUndefined(response.headers);\n    this.options.onHeaders(new grpc_web_1.grpc.Metadata(headers), response.statusCode);\n    response.on(\"data\", function (chunk) {\n      _this.options.debug && console.log(\"NodeHttp.data\", chunk);\n\n      _this.options.onChunk(toArrayBuffer(chunk));\n    });\n    response.on(\"end\", function () {\n      _this.options.debug && console.log(\"NodeHttp.end\");\n\n      _this.options.onEnd();\n    });\n  };\n\n  ;\n\n  NodeHttp.prototype.start = function (metadata) {\n    var _this = this;\n\n    var headers = {};\n    metadata.forEach(function (key, values) {\n      headers[key] = values.join(\", \");\n    });\n    var parsedUrl = url.parse(this.options.url);\n    var httpOptions = {\n      host: parsedUrl.hostname,\n      port: parsedUrl.port ? parseInt(parsedUrl.port) : undefined,\n      path: parsedUrl.path,\n      headers: headers,\n      method: \"POST\"\n    };\n\n    if (parsedUrl.protocol === \"https:\") {\n      this.request = https.request(httpOptions, this.responseCallback.bind(this));\n    } else {\n      this.request = http.request(httpOptions, this.responseCallback.bind(this));\n    }\n\n    this.request.on(\"error\", function (err) {\n      _this.options.debug && console.log(\"NodeHttp.error\", err);\n\n      _this.options.onEnd(err);\n    });\n  };\n\n  NodeHttp.prototype.cancel = function () {\n    this.options.debug && console.log(\"NodeHttp.abort\");\n    this.request.abort();\n  };\n\n  return NodeHttp;\n}();\n\nfunction filterHeadersForUndefined(headers) {\n  var filteredHeaders = {};\n\n  for (var key in headers) {\n    var value = headers[key];\n\n    if (headers.hasOwnProperty(key)) {\n      if (value !== undefined) {\n        filteredHeaders[key] = value;\n      }\n    }\n  }\n\n  return filteredHeaders;\n}\n\nfunction toArrayBuffer(buf) {\n  var view = new Uint8Array(buf.length);\n\n  for (var i = 0; i < buf.length; i++) {\n    view[i] = buf[i];\n  }\n\n  return view;\n}\n\nfunction toBuffer(ab) {\n  var buf = Buffer.alloc(ab.byteLength);\n\n  for (var i = 0; i < buf.length; i++) {\n    buf[i] = ab[i];\n  }\n\n  return buf;\n}","map":{"version":3,"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AAEA,SAAgBA,iBAAhB,GAAiC;EAC/B,OAAO,UAACC,IAAD,EAA4B;IACjC,OAAO,IAAIC,QAAJ,CAAaD,IAAb,CAAP;EACD,CAFD;AAGD;;AAJDE;;AAMA;EAIE,kBAAYC,gBAAZ,EAAmD;IACjD,KAAKC,OAAL,GAAeD,gBAAf;EACD;;EAEDF,2CAAYI,QAAZ,EAAgC;IAC9B,IAAI,CAAC,KAAKD,OAAL,CAAaE,gBAAb,CAA8BC,aAA/B,IAAiD,CAAC,KAAKH,OAAL,CAAaE,gBAAb,CAA8BE,cAApF,EAAoG;MAEhG,KAAKC,OAAL,CAAaC,SAAb,CAAuB,gBAAvB,EAAyCL,QAAQ,CAACM,UAAlD;IACH;;IACD,KAAKF,OAAL,CAAaG,KAAb,CAAmBC,QAAQ,CAACR,QAAD,CAA3B;IACA,KAAKI,OAAL,CAAaK,GAAb;EACD,CAPD;;EASAb,6CAEC,CAFD;;EAIAA,gDAAiBc,QAAjB,EAA+C;IAA/C;;IACE,KAAKX,OAAL,CAAaY,KAAb,IAAsBC,OAAO,CAACC,GAAR,CAAY,mBAAZ,EAAiCH,QAAQ,CAACI,UAA1C,CAAtB;IACA,IAAMC,OAAO,GAAGC,yBAAyB,CAACN,QAAQ,CAACK,OAAV,CAAzC;IACA,KAAKhB,OAAL,CAAakB,SAAb,CAAuB,IAAIC,gBAAKC,QAAT,CAAkBJ,OAAlB,CAAvB,EAAmDL,QAAQ,CAACI,UAA5D;IAEAJ,QAAQ,CAACU,EAAT,CAAY,MAAZ,EAAoB,iBAAK;MACvBC,KAAI,CAACtB,OAAL,CAAaY,KAAb,IAAsBC,OAAO,CAACC,GAAR,CAAY,eAAZ,EAA6BS,KAA7B,CAAtB;;MACAD,KAAI,CAACtB,OAAL,CAAawB,OAAb,CAAqBC,aAAa,CAACF,KAAD,CAAlC;IACD,CAHD;IAKAZ,QAAQ,CAACU,EAAT,CAAY,KAAZ,EAAmB;MACjBC,KAAI,CAACtB,OAAL,CAAaY,KAAb,IAAsBC,OAAO,CAACC,GAAR,CAAY,cAAZ,CAAtB;;MACAQ,KAAI,CAACtB,OAAL,CAAa0B,KAAb;IACD,CAHD;EAID,CAdD;;EAcC;;EAED7B,qCAAM8B,QAAN,EAA6B;IAA7B;;IACE,IAAMX,OAAO,GAA8B,EAA3C;IACAW,QAAQ,CAACC,OAAT,CAAiB,UAACC,GAAD,EAAMC,MAAN,EAAY;MAC3Bd,OAAO,CAACa,GAAD,CAAP,GAAeC,MAAM,CAACC,IAAP,CAAY,IAAZ,CAAf;IACD,CAFD;IAGA,IAAMC,SAAS,GAAGC,GAAG,CAACC,KAAJ,CAAU,KAAKlC,OAAL,CAAaiC,GAAvB,CAAlB;IAEA,IAAME,WAAW,GAAG;MAClBC,IAAI,EAAEJ,SAAS,CAACK,QADE;MAElBC,IAAI,EAAEN,SAAS,CAACM,IAAV,GAAiBC,QAAQ,CAACP,SAAS,CAACM,IAAX,CAAzB,GAA4CE,SAFhC;MAGlBC,IAAI,EAAET,SAAS,CAACS,IAHE;MAIlBzB,OAAO,EAAEA,OAJS;MAKlB0B,MAAM,EAAE;IALU,CAApB;;IAOA,IAAIV,SAAS,CAACW,QAAV,KAAuB,QAA3B,EAAqC;MACnC,KAAKtC,OAAL,GAAeuC,KAAK,CAACvC,OAAN,CAAc8B,WAAd,EAA2B,KAAKU,gBAAL,CAAsBC,IAAtB,CAA2B,IAA3B,CAA3B,CAAf;IACD,CAFD,MAEO;MACL,KAAKzC,OAAL,GAAe0C,IAAI,CAAC1C,OAAL,CAAa8B,WAAb,EAA0B,KAAKU,gBAAL,CAAsBC,IAAtB,CAA2B,IAA3B,CAA1B,CAAf;IACD;;IACD,KAAKzC,OAAL,CAAagB,EAAb,CAAgB,OAAhB,EAAyB,eAAG;MAC1BC,KAAI,CAACtB,OAAL,CAAaY,KAAb,IAAsBC,OAAO,CAACC,GAAR,CAAY,gBAAZ,EAA8BkC,GAA9B,CAAtB;;MACA1B,KAAI,CAACtB,OAAL,CAAa0B,KAAb,CAAmBsB,GAAnB;IACD,CAHD;EAID,CAvBD;;EAyBAnD;IACE,KAAKG,OAAL,CAAaY,KAAb,IAAsBC,OAAO,CAACC,GAAR,CAAY,gBAAZ,CAAtB;IACA,KAAKT,OAAL,CAAa4C,KAAb;EACD,CAHD;;EAIF;AAAC,CAlED;;AAoEA,SAAShC,yBAAT,CAAmCD,OAAnC,EAA0F;EACxF,IAAMkC,eAAe,GAAuC,EAA5D;;EAEA,KAAK,IAAIrB,GAAT,IAAgBb,OAAhB,EAAyB;IACvB,IAAMmC,KAAK,GAAGnC,OAAO,CAACa,GAAD,CAArB;;IACA,IAAIb,OAAO,CAACoC,cAAR,CAAuBvB,GAAvB,CAAJ,EAAiC;MAC/B,IAAIsB,KAAK,KAAKX,SAAd,EAAyB;QACvBU,eAAe,CAACrB,GAAD,CAAf,GAAuBsB,KAAvB;MACD;IACF;EACF;;EAED,OAAOD,eAAP;AACD;;AAED,SAASzB,aAAT,CAAuB4B,GAAvB,EAAkC;EAChC,IAAMC,IAAI,GAAG,IAAIC,UAAJ,CAAeF,GAAG,CAACG,MAAnB,CAAb;;EACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,GAAG,CAACG,MAAxB,EAAgCC,CAAC,EAAjC,EAAqC;IACnCH,IAAI,CAACG,CAAD,CAAJ,GAAUJ,GAAG,CAACI,CAAD,CAAb;EACD;;EACD,OAAOH,IAAP;AACD;;AAED,SAAS7C,QAAT,CAAkBiD,EAAlB,EAAgC;EAC9B,IAAML,GAAG,GAAGM,MAAM,CAACC,KAAP,CAAaF,EAAE,CAACnD,UAAhB,CAAZ;;EACA,KAAK,IAAIkD,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,GAAG,CAACG,MAAxB,EAAgCC,CAAC,EAAjC,EAAqC;IACnCJ,GAAG,CAACI,CAAD,CAAH,GAASC,EAAE,CAACD,CAAD,CAAX;EACD;;EACD,OAAOJ,GAAP;AACD","names":["NodeHttpTransport","opts","NodeHttp","exports","transportOptions","options","msgBytes","methodDefinition","requestStream","responseStream","request","setHeader","byteLength","write","toBuffer","end","response","debug","console","log","statusCode","headers","filterHeadersForUndefined","onHeaders","grpc_web_1","Metadata","on","_this","chunk","onChunk","toArrayBuffer","onEnd","metadata","forEach","key","values","join","parsedUrl","url","parse","httpOptions","host","hostname","port","parseInt","undefined","path","method","protocol","https","responseCallback","bind","http","err","abort","filteredHeaders","value","hasOwnProperty","buf","view","Uint8Array","length","i","ab","Buffer","alloc"],"sourceRoot":"","sources":["../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}