{"ast":null,"code":"'use strict';\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.extendAccounts = void 0;\n\nconst debug = require('debug')('thor:injector');\n\nconst thor_devkit_1 = require(\"thor-devkit\");\n\nconst utils = require(\"../utils\");\n\nconst extendAccounts = function (web3) {\n  const web3Utils = web3.utils; // signTransaction supports both callback and promise style\n\n  web3.eth.accounts.signTransaction = function signTransaction(ethTx, privateKey, callback) {\n    debug('tx to sign: %O', ethTx);\n\n    const sign = function (tx) {\n      return __awaiter(this, void 0, void 0, function* () {\n        if (!tx.chainTag) {\n          const chainTag = yield web3.eth.getChainTag();\n\n          if (chainTag) {\n            tx.chainTag = chainTag;\n          } else {\n            throw new Error('error getting chainTag');\n          }\n        }\n\n        if (!tx.blockRef) {\n          const blockRef = yield web3.eth.getBlockRef();\n\n          if (blockRef) {\n            tx.blockRef = blockRef;\n          } else {\n            throw new Error('error getting blockRef');\n          }\n        }\n\n        if (tx.data && utils.isHex(tx.data)) {\n          tx.data = utils.toPrefixedHex(tx.data);\n        } else if (tx.data) {\n          throw new Error('Data must be valid hex');\n        } else {\n          tx.data = '0x';\n        }\n\n        if (!tx.gas) {\n          const pubKey = thor_devkit_1.cry.secp256k1.derivePublicKey(Buffer.from(utils.sanitizeHex(privateKey), 'hex'));\n          const from = '0x' + thor_devkit_1.cry.publicKeyToAddress(pubKey).toString('hex');\n          const gas = yield web3.eth.estimateGas({\n            from,\n            to: tx.to ? tx.to : '',\n            value: tx.value ? tx.value : 0,\n            data: tx.data\n          });\n          tx.gas = gas;\n        }\n\n        if (!tx.nonce) {\n          tx.nonce = utils.newNonce();\n        }\n\n        const clause = {\n          value: tx.value || 0,\n          to: tx.to || null,\n          data: tx.data\n        };\n        const body = {\n          chainTag: utils.validNumberOrDefault(tx.chainTag, 0),\n          blockRef: tx.blockRef,\n          gas: tx.gas,\n          expiration: utils.validNumberOrDefault(tx.expiration, utils.params.defaultExpiration),\n          gasPriceCoef: utils.validNumberOrDefault(tx.gasPriceCoef, utils.params.defaultGasPriceCoef),\n          dependsOn: !tx.dependsOn ? null : tx.dependsOn,\n          nonce: typeof tx.nonce === 'string' ? utils.toPrefixedHex(tx.nonce) : tx.nonce,\n          clauses: [clause]\n        };\n        debug('body: %O', body);\n        const ThorTx = new thor_devkit_1.Transaction(body);\n        const priKey = Buffer.from(utils.sanitizeHex(privateKey), 'hex');\n        const signingHash = thor_devkit_1.cry.blake2b256(ThorTx.encode());\n        ThorTx.signature = thor_devkit_1.cry.secp256k1.sign(signingHash, priKey);\n        const result = {\n          rawTransaction: utils.toPrefixedHex(ThorTx.encode().toString('hex')),\n          messageHash: signingHash\n        };\n        return result;\n      });\n    }; // for supporting both callback and promise\n\n\n    if (callback instanceof Function) {\n      sign(ethTx).then(ret => {\n        return callback(null, ret);\n      }).catch(e => {\n        return callback(e);\n      });\n    } else {\n      return sign(ethTx);\n    }\n  };\n\n  web3.eth.accounts.recoverTransaction = function recoverTransaction(encodedRawTx) {\n    const decoded = thor_devkit_1.Transaction.decode(Buffer.from(utils.sanitizeHex(encodedRawTx), 'hex'));\n    return decoded.origin;\n  };\n\n  web3.eth.accounts.hashMessage = function hashMessage(data) {\n    const message = web3Utils.isHexStrict(data) ? web3Utils.hexToBytes(data) : data;\n    const messageBuffer = Buffer.from(message);\n    const prefix = '\\u0019VeChain Signed Message:\\n' + message.length.toString();\n    const prefixBuffer = Buffer.from(prefix);\n    const prefixedMessage = Buffer.concat([prefixBuffer, messageBuffer]);\n    return utils.toPrefixedHex(thor_devkit_1.cry.blake2b256(prefixedMessage).toString('hex'));\n  };\n\n  web3.eth.accounts.sign = function sign(data, privateKey) {\n    const hash = this.hashMessage(data);\n    const hashBuffer = Buffer.from(utils.sanitizeHex(hash), 'hex');\n    const privateKeyBuffer = Buffer.from(utils.sanitizeHex(privateKey), 'hex');\n    const signature = thor_devkit_1.cry.secp256k1.sign(hashBuffer, privateKeyBuffer).toString('hex');\n    return {\n      message: data,\n      messageHash: utils.toPrefixedHex(hash),\n      signature: utils.toPrefixedHex(signature)\n    };\n  };\n\n  web3.eth.accounts.recover = function recover(message, signature, preFixed) {\n    if (utils.isObject(message)) {\n      return this.recover(message.messageHash, message.signature, true);\n    }\n\n    if (!preFixed) {\n      message = this.hashMessage(message);\n    }\n\n    const hexBuffer = Buffer.from(utils.sanitizeHex(message), 'hex');\n    const signatureBuffer = Buffer.from(utils.sanitizeHex(signature), 'hex');\n    const pubKey = thor_devkit_1.cry.secp256k1.recover(hexBuffer, signatureBuffer);\n    const address = thor_devkit_1.cry.publicKeyToAddress(pubKey);\n    return utils.toPrefixedHex(address.toString('hex'));\n  };\n};\n\nexports.extendAccounts = extendAccounts;","map":{"version":3,"mappings":"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","names":["debug","require","extendAccounts","web3","web3Utils","utils","eth","accounts","signTransaction","ethTx","privateKey","callback","sign","tx","chainTag","getChainTag","Error","blockRef","getBlockRef","data","isHex","toPrefixedHex","gas","pubKey","thor_devkit_1","secp256k1","derivePublicKey","Buffer","from","sanitizeHex","publicKeyToAddress","toString","estimateGas","to","value","nonce","newNonce","clause","body","validNumberOrDefault","expiration","params","defaultExpiration","gasPriceCoef","defaultGasPriceCoef","dependsOn","clauses","ThorTx","priKey","signingHash","blake2b256","encode","signature","result","rawTransaction","messageHash","Function","then","ret","catch","e","recoverTransaction","encodedRawTx","decoded","decode","origin","hashMessage","message","isHexStrict","hexToBytes","messageBuffer","prefix","length","prefixBuffer","prefixedMessage","concat","hash","hashBuffer","privateKeyBuffer","recover","preFixed","isObject","hexBuffer","signatureBuffer","address","exports"],"sourceRoot":"","sources":["../../src/extend/accounts.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}