{"ast":null,"code":"import { BigNumber, constants, utils } from \"ethers\";\nconst logger = new utils.Logger(\"celo/transactions\");\nexport const celoTransactionFields = [{\n  name: \"nonce\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"gasPrice\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"gasLimit\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"feeCurrency\",\n  length: 20\n}, {\n  name: \"gatewayFeeRecipient\",\n  length: 20\n}, {\n  name: \"gatewayFee\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"to\",\n  length: 20\n}, {\n  name: \"value\",\n  maxLength: 32,\n  numeric: true\n}, {\n  name: \"data\"\n}];\nexport const celoAllowedTransactionKeys = {\n  chainId: true,\n  data: true,\n  gasLimit: true,\n  gasPrice: true,\n  nonce: true,\n  to: true,\n  value: true,\n  feeCurrency: true,\n  gatewayFeeRecipient: true,\n  gatewayFee: true\n}; // Almost identical to https://github.com/ethers-io/ethers.js/blob/master/packages/transactions/src.ts/index.ts#L85\n// Need to override to use the celo tx prop whitelists above\n\nexport function serializeCeloTransaction(transaction, signature) {\n  utils.checkProperties(transaction, celoAllowedTransactionKeys);\n  const raw = [];\n  celoTransactionFields.forEach(function (fieldInfo) {\n    let value = transaction[fieldInfo.name] || [];\n    const options = {};\n\n    if (fieldInfo.numeric) {\n      options.hexPad = \"left\";\n    }\n\n    value = utils.arrayify(utils.hexlify(value, options)); // Fixed-width field\n\n    if (fieldInfo.length && value.length !== fieldInfo.length && value.length > 0) {\n      logger.throwArgumentError(\"invalid length for \" + fieldInfo.name, \"transaction:\" + fieldInfo.name, value);\n    } // Variable-width (with a maximum)\n\n\n    if (fieldInfo.maxLength) {\n      value = utils.stripZeros(value);\n\n      if (value.length > fieldInfo.maxLength) {\n        logger.throwArgumentError(\"invalid length for \" + fieldInfo.name, \"transaction:\" + fieldInfo.name, value);\n      }\n    }\n\n    raw.push(utils.hexlify(value));\n  });\n  let chainId = 0;\n\n  if (transaction.chainId != null) {\n    // A chainId was provided; if non-zero we'll use EIP-155\n    chainId = transaction.chainId;\n\n    if (typeof chainId !== \"number\") {\n      logger.throwArgumentError(\"invalid transaction.chainId\", \"transaction\", transaction);\n    }\n  } else if (signature && !utils.isBytesLike(signature) && signature.v && signature.v > 28) {\n    // No chainId provided, but the signature is signing with EIP-155; derive chainId\n    chainId = Math.floor((signature.v - 35) / 2);\n  } // We have an EIP-155 transaction (chainId was specified and non-zero)\n\n\n  if (chainId !== 0) {\n    raw.push(utils.hexlify(chainId)); // @TODO: hexValue?\n\n    raw.push(\"0x\");\n    raw.push(\"0x\");\n  } // Requesting an unsigned transation\n\n\n  if (!signature) {\n    return utils.RLP.encode(raw);\n  } // The splitSignature will ensure the transaction has a recoveryParam in the\n  // case that the signTransaction function only adds a v.\n\n\n  const sig = utils.splitSignature(signature); // We pushed a chainId and null r, s on for hashing only; remove those\n\n  let v = 27 + sig.recoveryParam;\n\n  if (chainId !== 0) {\n    raw.pop();\n    raw.pop();\n    raw.pop();\n    v += chainId * 2 + 8; // If an EIP-155 v (directly or indirectly; maybe _vs) was provided, check it!\n\n    if (sig.v > 28 && sig.v !== v) {\n      logger.throwArgumentError(\"transaction.chainId/signature.v mismatch\", \"signature\", signature);\n    }\n  } else if (sig.v !== v) {\n    logger.throwArgumentError(\"transaction.chainId/signature.v mismatch\", \"signature\", signature);\n  }\n\n  raw.push(utils.hexlify(v));\n  raw.push(utils.stripZeros(utils.arrayify(sig.r)));\n  raw.push(utils.stripZeros(utils.arrayify(sig.s)));\n  return utils.RLP.encode(raw);\n} // Almost identical to https://github.com/ethers-io/ethers.js/blob/master/packages/transactions/src.ts/index.ts#L165\n// Need to override to use the celo tx prop whitelists above\n\nexport function parseCeloTransaction(rawTransaction) {\n  const transaction = utils.RLP.decode(rawTransaction);\n\n  if (transaction.length !== 12 && transaction.length !== 9) {\n    logger.throwArgumentError(\"invalid raw transaction\", \"rawTransaction\", rawTransaction);\n  }\n\n  const tx = {\n    nonce: handleNumber(transaction[0]).toNumber(),\n    gasPrice: handleNumber(transaction[1]),\n    gasLimit: handleNumber(transaction[2]),\n    feeCurrency: handleAddress(transaction[3]),\n    gatewayFeeRecipient: handleAddress(transaction[4]),\n    gatewayFee: handleNumber(transaction[5]),\n    to: handleAddress(transaction[6]),\n    value: handleNumber(transaction[7]),\n    data: transaction[8],\n    chainId: 0\n  }; // Legacy unsigned transaction\n\n  if (transaction.length === 9) {\n    return tx;\n  }\n\n  try {\n    tx.v = BigNumber.from(transaction[9]).toNumber();\n  } catch (error) {\n    console.log(error);\n    return tx;\n  }\n\n  tx.r = utils.hexZeroPad(transaction[10], 32);\n  tx.s = utils.hexZeroPad(transaction[11], 32);\n\n  if (BigNumber.from(tx.r).isZero() && BigNumber.from(tx.s).isZero()) {\n    // EIP-155 unsigned transaction\n    tx.chainId = tx.v;\n    tx.v = 0;\n  } else {\n    // Signed Tranasaction\n    tx.chainId = Math.floor((tx.v - 35) / 2);\n\n    if (tx.chainId < 0) {\n      tx.chainId = 0;\n    }\n\n    let recoveryParam = tx.v - 27;\n    const raw = transaction.slice(0, 6);\n\n    if (tx.chainId !== 0) {\n      raw.push(utils.hexlify(tx.chainId));\n      raw.push(\"0x\");\n      raw.push(\"0x\");\n      recoveryParam -= tx.chainId * 2 + 8;\n    }\n\n    const digest = utils.keccak256(utils.RLP.encode(raw));\n\n    try {\n      tx.from = utils.recoverAddress(digest, {\n        r: utils.hexlify(tx.r),\n        s: utils.hexlify(tx.s),\n        recoveryParam: recoveryParam\n      });\n    } catch (error) {\n      console.log(error);\n    }\n\n    tx.hash = utils.keccak256(rawTransaction);\n  }\n\n  return tx;\n}\n\nfunction handleAddress(value) {\n  if (value === \"0x\") {\n    return undefined;\n  }\n\n  return utils.getAddress(value);\n}\n\nfunction handleNumber(value) {\n  if (value === \"0x\") {\n    return constants.Zero;\n  }\n\n  return BigNumber.from(value);\n}","map":{"version":3,"mappings":"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","names":["BigNumber","constants","utils","logger","Logger","celoTransactionFields","name","maxLength","numeric","length","celoAllowedTransactionKeys","chainId","data","gasLimit","gasPrice","nonce","to","value","feeCurrency","gatewayFeeRecipient","gatewayFee","serializeCeloTransaction","transaction","signature","checkProperties","raw","forEach","fieldInfo","options","hexPad","arrayify","hexlify","throwArgumentError","stripZeros","push","isBytesLike","v","Math","floor","RLP","encode","sig","splitSignature","recoveryParam","pop","r","s","parseCeloTransaction","rawTransaction","decode","tx","handleNumber","toNumber","handleAddress","from","error","console","log","hexZeroPad","isZero","slice","digest","keccak256","recoverAddress","hash","undefined","getAddress","Zero"],"sourceRoot":"","sources":["../../../src/lib/transactions.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}