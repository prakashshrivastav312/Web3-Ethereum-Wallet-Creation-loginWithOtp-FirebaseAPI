{"ast":null,"code":"\"use strict\";\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.sendCeloOffchainTransaction = void 0;\n\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\n\nconst web3_utils_1 = require(\"web3-utils\");\n\nconst tatum_1 = require(\"../connector/tatum\");\n\nconst constants_1 = require(\"../constants\");\n\nconst ledger_1 = require(\"../ledger\");\n\nconst model_1 = require(\"../model\");\n\nconst TransferCeloOffchain_1 = require(\"../model/request/TransferCeloOffchain\");\n\nconst transaction_1 = require(\"../transaction\");\n\nconst wallet_1 = require(\"../wallet\");\n\nconst common_1 = require(\"./common\");\n\nconst kms_1 = require(\"./kms\");\n/**\n * Send Celo transaction from Tatum Ledger account to the blockchain. This method broadcasts signed transaction to the blockchain.\n * This operation is irreversible.\n * @param testnet mainnet or testnet version\n * @param body content of the transaction to broadcast\n * @param provider url of the Celo Server to connect to. If not set, default public server will be used.\n * @returns transaction id of the transaction in the blockchain or id of the withdrawal, if it was not cancelled automatically\n */\n\n\nconst sendCeloOffchainTransaction = async (testnet, body, provider) => {\n  if (body.signatureId) {\n    return kms_1.offchainTransferCeloKMS(body);\n  }\n\n  await tatum_1.validateBody(body, TransferCeloOffchain_1.TransferCeloOffchain);\n\n  const {\n    mnemonic,\n    index,\n    privateKey,\n    gasLimit,\n    gasPrice,\n    nonce,\n    feeCurrency\n  } = body,\n        withdrawal = __rest(body, [\"mnemonic\", \"index\", \"privateKey\", \"gasLimit\", \"gasPrice\", \"nonce\", \"feeCurrency\"]);\n\n  const {\n    amount,\n    address\n  } = withdrawal;\n  const fromPriv = mnemonic && index !== undefined ? await wallet_1.generatePrivateKeyFromMnemonic(model_1.Currency.CELO, testnet, mnemonic, index) : privateKey;\n  const account = await ledger_1.getAccountById(withdrawal.senderAccountId);\n  let txData;\n  const fee = {\n    gasLimit: gasLimit || '150000',\n    gasPrice: gasPrice || '0.5'\n  };\n\n  if (constants_1.CELO_BASED_CURRENCIES.includes(account.currency)) {\n    txData = await transaction_1.prepareCeloOrCUsdSignedTransaction(testnet, {\n      amount,\n      fromPrivateKey: fromPriv,\n      currency: account.currency,\n      feeCurrency,\n      nonce,\n      to: address\n    }, provider);\n  } else {\n    const vc = await ledger_1.getVirtualCurrencyByName(account.currency);\n    txData = await transaction_1.prepareCeloTransferErc20SignedTransaction(testnet, {\n      amount,\n      feeCurrency,\n      fromPrivateKey: fromPriv,\n      to: address,\n      nonce,\n      contractAddress: vc.erc20Address\n    }, provider);\n  } // @ts-ignore\n\n\n  withdrawal.fee = web3_utils_1.fromWei(new bignumber_js_1.default(fee.gasLimit).multipliedBy(web3_utils_1.toWei(fee.gasPrice, 'gwei')).toString(), 'ether');\n  const {\n    id\n  } = await common_1.offchainStoreWithdrawal(withdrawal);\n\n  try {\n    return Object.assign(Object.assign({}, await common_1.offchainBroadcast({\n      txData,\n      withdrawalId: id,\n      currency: model_1.Currency.CELO\n    })), {\n      id\n    });\n  } catch (e) {\n    console.error(e);\n\n    try {\n      await common_1.offchainCancelWithdrawal(id);\n    } catch (e1) {\n      console.log(e);\n      return {\n        id\n      };\n    }\n  }\n};\n\nexports.sendCeloOffchainTransaction = sendCeloOffchainTransaction;","map":{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;AAEA;;;;;;;;;;AAQO,MAAMA,2BAA2B,GAAG,OAAOC,OAAP,EAAyBC,IAAzB,EAAqDC,QAArD,KAA0E;EACjH,IAAID,IAAI,CAACE,WAAT,EAAsB;IAClB,OAAOC,8BAAwBH,IAAxB,CAAP;EACH;;EACD,MAAMI,qBAAaJ,IAAb,EAAmBK,2CAAnB,CAAN;;EACA,MAAM;IACFC,QADE;IACQC,KADR;IACeC,UADf;IAC2BC,QAD3B;IACqCC,QADrC;IAC+CC,KAD/C;IACsDC;EADtD,IAEFZ,IAFJ;EAAA,MAC4Ea,UAAU,UAClFb,IADkF,EADhF,mFACgF,CADtF;;EAGA,MAAM;IAACc,MAAD;IAASC;EAAT,IAAoBF,UAA1B;EAEA,MAAMG,QAAQ,GAAGV,QAAQ,IAAIC,KAAK,KAAKU,SAAtB,GAAkC,MAAMC,wCAA+BC,iBAASC,IAAxC,EAA8CrB,OAA9C,EAAuDO,QAAvD,EAAiEC,KAAjE,CAAxC,GAAkHC,UAAnI;EAEA,MAAMa,OAAO,GAAG,MAAMC,wBAAeT,UAAU,CAACU,eAA1B,CAAtB;EACA,IAAIC,MAAJ;EACA,MAAMC,GAAG,GAAG;IACRhB,QAAQ,EAAEA,QAAQ,IAAI,QADd;IAERC,QAAQ,EAAEA,QAAQ,IAAI;EAFd,CAAZ;;EAIA,IAAIgB,kCAAsBC,QAAtB,CAA+BN,OAAO,CAACO,QAAvC,CAAJ,EAAsD;IAClDJ,MAAM,GAAG,MAAMK,iDAAmC9B,OAAnC,EAA4C;MACvDe,MADuD;MAEvDgB,cAAc,EAAEd,QAFuC;MAGvDY,QAAQ,EAAEP,OAAO,CAACO,QAHqC;MAIvDhB,WAJuD;MAKvDD,KALuD;MAMvDoB,EAAE,EAAEhB;IANmD,CAA5C,EAOZd,QAPY,CAAf;EAQH,CATD,MASO;IACH,MAAM+B,EAAE,GAAG,MAAMV,kCAAyBD,OAAO,CAACO,QAAjC,CAAjB;IACAJ,MAAM,GAAG,MAAMK,wDAA0C9B,OAA1C,EAAmD;MAC9De,MAD8D;MAE9DF,WAF8D;MAG9DkB,cAAc,EAAEd,QAH8C;MAI9De,EAAE,EAAEhB,OAJ0D;MAK9DJ,KAL8D;MAM9DsB,eAAe,EAAED,EAAE,CAACE;IAN0C,CAAnD,EAOZjC,QAPY,CAAf;EAQH,CArCgH,CAsCjH;;;EACAY,UAAU,CAACY,GAAX,GAAiBU,qBAAQ,IAAIC,sBAAJ,CAAcX,GAAG,CAAChB,QAAlB,EAA4B4B,YAA5B,CAAyCF,mBAAMV,GAAG,CAACf,QAAV,EAAoB,MAApB,CAAzC,EAAsE4B,QAAtE,EAAR,EAA0F,OAA1F,CAAjB;EACA,MAAM;IAACC;EAAD,IAAO,MAAMC,iCAAwB3B,UAAxB,CAAnB;;EACA,IAAI;IACA,uCAAW,MAAM2B,2BAAkB;MAAChB,MAAD;MAASiB,YAAY,EAAEF,EAAvB;MAA2BX,QAAQ,EAAET,iBAASC;IAA9C,CAAlB,CAAjB,GAAuF;MAAEmB;IAAF,CAAvF;EACH,CAFD,CAEE,OAAOG,CAAP,EAAU;IACRC,OAAO,CAACC,KAAR,CAAcF,CAAd;;IACA,IAAI;MACA,MAAMF,kCAAyBD,EAAzB,CAAN;IACH,CAFD,CAEE,OAAOM,EAAP,EAAW;MACTF,OAAO,CAACG,GAAR,CAAYJ,CAAZ;MACA,OAAO;QAACH;MAAD,CAAP;IACH;EACJ;AACJ,CApDM;;AAAMQ,sCAA2BjD,2BAA3B","names":["sendCeloOffchainTransaction","testnet","body","provider","signatureId","kms_1","tatum_1","TransferCeloOffchain_1","mnemonic","index","privateKey","gasLimit","gasPrice","nonce","feeCurrency","withdrawal","amount","address","fromPriv","undefined","wallet_1","model_1","CELO","account","ledger_1","senderAccountId","txData","fee","constants_1","includes","currency","transaction_1","fromPrivateKey","to","vc","contractAddress","erc20Address","web3_utils_1","bignumber_js_1","multipliedBy","toString","id","common_1","withdrawalId","e","console","error","e1","log","exports"],"sourceRoot":"","sources":["../../../src/offchain/celo.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}