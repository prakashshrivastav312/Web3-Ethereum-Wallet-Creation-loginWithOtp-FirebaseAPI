{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.getOrderbook = exports.formatBidsAndAsks = void 0;\n\nconst _ = __importStar(require(\"lodash\"));\n\nconst utils = __importStar(require(\"./utils\"));\n\nconst orderbook_order_1 = require(\"./parse/orderbook-order\");\n\nconst common_1 = require(\"../common\");\n\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\n\nfunction isSameIssue(a, b) {\n  return a.currency === b.currency && a.counterparty === b.counterparty;\n}\n\nfunction directionFilter(direction, order) {\n  return order.specification.direction === direction;\n}\n\nfunction flipOrder(order) {\n  const specification = order.specification;\n  const flippedSpecification = {\n    quantity: specification.totalPrice,\n    totalPrice: specification.quantity,\n    direction: specification.direction === 'buy' ? 'sell' : 'buy'\n  };\n\n  const newSpecification = _.merge({}, specification, flippedSpecification);\n\n  return _.merge({}, order, {\n    specification: newSpecification\n  });\n}\n\nfunction alignOrder(base, order) {\n  const quantity = order.specification.quantity;\n  return isSameIssue(quantity, base) ? order : flipOrder(order);\n}\n\nfunction formatBidsAndAsks(orderbook, offers) {\n  const orders = offers.sort((a, b) => {\n    return new bignumber_js_1.default(a.quality).comparedTo(b.quality);\n  }).map(orderbook_order_1.parseOrderbookOrder);\n  const alignedOrders = orders.map(_.partial(alignOrder, orderbook.base));\n  const bids = alignedOrders.filter(_.partial(directionFilter, 'buy'));\n  const asks = alignedOrders.filter(_.partial(directionFilter, 'sell'));\n  return {\n    bids,\n    asks\n  };\n}\n\nexports.formatBidsAndAsks = formatBidsAndAsks;\n\nfunction makeRequest(api, taker, options, takerGets, takerPays) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const orderData = utils.renameCounterpartyToIssuerInOrder({\n      taker_gets: takerGets,\n      taker_pays: takerPays\n    });\n    return api._requestAll('book_offers', {\n      taker_gets: orderData.taker_gets,\n      taker_pays: orderData.taker_pays,\n      ledger_index: options.ledgerVersion || 'validated',\n      limit: options.limit,\n      taker\n    });\n  });\n}\n\nfunction getOrderbook(address, orderbook) {\n  let options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n  return __awaiter(this, void 0, void 0, function* () {\n    common_1.validate.getOrderbook({\n      address,\n      orderbook,\n      options\n    });\n    const [directOfferResults, reverseOfferResults] = yield Promise.all([makeRequest(this, address, options, orderbook.base, orderbook.counter), makeRequest(this, address, options, orderbook.counter, orderbook.base)]);\n\n    const directOffers = _.flatMap(directOfferResults, directOfferResult => directOfferResult.offers);\n\n    const reverseOffers = _.flatMap(reverseOfferResults, reverseOfferResult => reverseOfferResult.offers);\n\n    return formatBidsAndAsks(orderbook, [...directOffers, ...reverseOffers]);\n  });\n}\n\nexports.getOrderbook = getOrderbook;","map":{"version":3,"mappings":"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","names":["isSameIssue","a","b","currency","counterparty","directionFilter","direction","order","specification","flipOrder","flippedSpecification","quantity","totalPrice","newSpecification","_","merge","alignOrder","base","formatBidsAndAsks","orderbook","offers","orders","sort","bignumber_js_1","quality","comparedTo","map","orderbook_order_1","alignedOrders","partial","bids","filter","asks","exports","makeRequest","api","taker","options","takerGets","takerPays","orderData","utils","renameCounterpartyToIssuerInOrder","taker_gets","taker_pays","_requestAll","ledger_index","ledgerVersion","limit","getOrderbook","address","common_1","directOfferResults","reverseOfferResults","Promise","all","counter","directOffers","flatMap","directOfferResult","reverseOffers","reverseOfferResult"],"sourceRoot":"","sources":["../../../src/ledger/orderbook.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}