{"ast":null,"code":"// OP_0 [signatures ...]\nvar Buffer = require('safe-buffer').Buffer;\n\nvar bscript = require('../../script');\n\nvar p2mso = require('./output');\n\nvar typeforce = require('typeforce');\n\nvar OPS = require('@tatumio/bitcoincash-ops');\n\nfunction partialSignature(value) {\n  return value === OPS.OP_0 || bscript.isCanonicalSignature(value);\n}\n\nfunction check(script, allowIncomplete) {\n  var chunks = bscript.decompile(script);\n  if (chunks.length < 2) return false;\n  if (chunks[0] !== OPS.OP_0) return false;\n\n  if (allowIncomplete) {\n    return chunks.slice(1).every(partialSignature);\n  }\n\n  return chunks.slice(1).every(bscript.isCanonicalSignature);\n}\n\ncheck.toJSON = function () {\n  return 'multisig input';\n};\n\nvar EMPTY_BUFFER = Buffer.allocUnsafe(0);\n\nfunction encodeStack(signatures, scriptPubKey) {\n  typeforce([partialSignature], signatures);\n\n  if (scriptPubKey) {\n    var scriptData = p2mso.decode(scriptPubKey);\n\n    if (signatures.length < scriptData.m) {\n      throw new TypeError('Not enough signatures provided');\n    }\n\n    if (signatures.length > scriptData.pubKeys.length) {\n      throw new TypeError('Too many signatures provided');\n    }\n  }\n\n  return [].concat(EMPTY_BUFFER, signatures.map(function (sig) {\n    if (sig === OPS.OP_0) {\n      return EMPTY_BUFFER;\n    }\n\n    return sig;\n  }));\n}\n\nfunction encode(signatures, scriptPubKey) {\n  return bscript.compile(encodeStack(signatures, scriptPubKey));\n}\n\nfunction decodeStack(stack, allowIncomplete) {\n  typeforce(typeforce.Array, stack);\n  typeforce(check, stack, allowIncomplete);\n  return stack.slice(1);\n}\n\nfunction decode(buffer, allowIncomplete) {\n  var stack = bscript.decompile(buffer);\n  return decodeStack(stack, allowIncomplete);\n}\n\nmodule.exports = {\n  check: check,\n  decode: decode,\n  decodeStack: decodeStack,\n  encode: encode,\n  encodeStack: encodeStack\n};","map":{"version":3,"names":["Buffer","require","bscript","p2mso","typeforce","OPS","partialSignature","value","OP_0","isCanonicalSignature","check","script","allowIncomplete","chunks","decompile","length","slice","every","toJSON","EMPTY_BUFFER","allocUnsafe","encodeStack","signatures","scriptPubKey","scriptData","decode","m","TypeError","pubKeys","concat","map","sig","encode","compile","decodeStack","stack","Array","buffer","module","exports"],"sources":["C:/Users/acer/node_modules/@tatumio/bitcoincashjs2-lib/src/templates/multisig/input.js"],"sourcesContent":["// OP_0 [signatures ...]\n\nvar Buffer = require('safe-buffer').Buffer\nvar bscript = require('../../script')\nvar p2mso = require('./output')\nvar typeforce = require('typeforce')\nvar OPS = require('@tatumio/bitcoincash-ops')\n\nfunction partialSignature (value) {\n  return value === OPS.OP_0 || bscript.isCanonicalSignature(value)\n}\n\nfunction check (script, allowIncomplete) {\n  var chunks = bscript.decompile(script)\n  if (chunks.length < 2) return false\n  if (chunks[0] !== OPS.OP_0) return false\n\n  if (allowIncomplete) {\n    return chunks.slice(1).every(partialSignature)\n  }\n\n  return chunks.slice(1).every(bscript.isCanonicalSignature)\n}\ncheck.toJSON = function () { return 'multisig input' }\n\nvar EMPTY_BUFFER = Buffer.allocUnsafe(0)\n\nfunction encodeStack (signatures, scriptPubKey) {\n  typeforce([partialSignature], signatures)\n\n  if (scriptPubKey) {\n    var scriptData = p2mso.decode(scriptPubKey)\n\n    if (signatures.length < scriptData.m) {\n      throw new TypeError('Not enough signatures provided')\n    }\n\n    if (signatures.length > scriptData.pubKeys.length) {\n      throw new TypeError('Too many signatures provided')\n    }\n  }\n\n  return [].concat(EMPTY_BUFFER, signatures.map(function (sig) {\n    if (sig === OPS.OP_0) {\n      return EMPTY_BUFFER\n    }\n    return sig\n  }))\n}\n\nfunction encode (signatures, scriptPubKey) {\n  return bscript.compile(encodeStack(signatures, scriptPubKey))\n}\n\nfunction decodeStack (stack, allowIncomplete) {\n  typeforce(typeforce.Array, stack)\n  typeforce(check, stack, allowIncomplete)\n  return stack.slice(1)\n}\n\nfunction decode (buffer, allowIncomplete) {\n  var stack = bscript.decompile(buffer)\n  return decodeStack(stack, allowIncomplete)\n}\n\nmodule.exports = {\n  check: check,\n  decode: decode,\n  decodeStack: decodeStack,\n  encode: encode,\n  encodeStack: encodeStack\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}