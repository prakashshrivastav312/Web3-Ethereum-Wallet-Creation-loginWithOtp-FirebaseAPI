{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.extendContracts = void 0;\n\nconst debug = require('debug')('thor:injector');\n\nconst Subscription = require('web3-core-subscriptions').subscription;\n\nconst utils = require(\"../utils\");\n\nconst formatters_1 = require(\"./formatters\");\n\nconst extendContracts = function (web3) {\n  const _encodeEventABI = web3.eth.Contract.prototype._encodeEventABI;\n\n  web3.eth.Contract.prototype._encodeEventABI = function (event, options) {\n    debug('_encodeEventABI');\n\n    const result = _encodeEventABI.call(this, event, options);\n\n    if (options.options) {\n      result.options = options.options;\n    }\n\n    if (options.range) {\n      result.range = options.range;\n    }\n\n    if (options.order) {\n      result.order = options.order;\n    }\n\n    return result;\n  };\n\n  web3.eth.Contract.prototype._on = function () {\n    debug('_on'); // keeps the code from web3\n\n    const subOptions = this._generateEventOptions.apply(this, arguments); // prevent the event \"newListener\" and \"removeListener\" from being overwritten\n\n\n    this._checkListener('newListener', subOptions.event.name, subOptions.callback);\n\n    this._checkListener('removeListener', subOptions.event.name, subOptions.callback); // TODO check if listener already exists? and reuse subscription if options are the same.\n    // create new subscription\n\n    /* changes from web3 starts the following\n     */\n    // subscription options in thor doesn't support array as topic filter object\n\n\n    const filterOptions = {\n      address: subOptions.params.address\n    };\n\n    if (subOptions.params.fromBlock) {\n      filterOptions.pos = utils.validBytes32OrError(subOptions.params.fromBlock, '[thorify] fromBlock must be blockID');\n    }\n\n    debug('Contract filter option: %O', filterOptions);\n\n    if (subOptions.params.topics) {\n      for (const [index, value] of subOptions.params.topics.entries()) {\n        if (value === null) {\n          continue;\n        }\n\n        if (typeof value === 'string') {\n          filterOptions['t' + index] = value;\n        } else {\n          throw new Error('[thorify] Array filter option is not supported in thor, must be null or bytes32 string');\n        }\n      }\n    }\n\n    const decodeEventABI = this._decodeEventABI.bind(subOptions.event);\n\n    const subscription = new Subscription({\n      subscription: {\n        params: 1,\n        inputFormatter: [formatters_1.inputLogFilterFormatter],\n\n        subscriptionHandler(subscriptionMsg) {\n          if (subscriptionMsg.error) {\n            this.emit('error', subscriptionMsg.error); // web3-core-subscriptions/subscription sets a default value for this.callback\n\n            this.callback(subscriptionMsg.error, null, this);\n          } else {\n            const result = decodeEventABI(subscriptionMsg.data);\n\n            if (result.removed) {\n              this.emit('changed', result);\n            } else {\n              this.emit('data', result);\n            } // web3-core-subscriptions/subscription sets a default value for this.callback\n\n\n            this.callback(null, result, this);\n          }\n        }\n\n      },\n      type: 'eth',\n      requestManager: this._requestManager\n    });\n    subscription.subscribe('logs', filterOptions, subOptions.callback || function () {});\n    return subscription;\n  };\n};\n\nexports.extendContracts = extendContracts;","map":{"version":3,"mappings":"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","names":["debug","require","Subscription","subscription","extendContracts","web3","_encodeEventABI","eth","Contract","prototype","event","options","result","call","range","order","_on","subOptions","_generateEventOptions","apply","arguments","_checkListener","name","callback","filterOptions","address","params","fromBlock","pos","utils","validBytes32OrError","topics","index","value","entries","Error","decodeEventABI","_decodeEventABI","bind","inputFormatter","formatters_1","subscriptionHandler","subscriptionMsg","error","emit","data","removed","type","requestManager","_requestManager","subscribe","exports"],"sourceRoot":"","sources":["../../src/extend/contracts.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}